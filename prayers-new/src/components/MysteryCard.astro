---
import type { CollectionEntry } from 'astro:content';

interface Props {
  mysteries: CollectionEntry<'mysteries'>[];
}

const { mysteries } = Astro.props;

// Pass the data to the client-side script safely
const mysteryData = mysteries.map(m => ({
  title: m.data.title,
  slug: m.slug,
  list: m.data.mysteries || []
}));
---

<div class="todays-mystery" id="mystery-card">
  <h3><a href="#" id="mystery-link">Loading today's mystery...</a></h3>
  <p><em>Today's recommended mystery for <span id="mystery-date">...</span></em></p>
  
  <div class="mystery-list">
    <strong>The Five Mysteries:</strong>
    <ol id="mystery-ol">
      <!-- Populated by JS -->
    </ol>
  </div>
  
  <a href="#" class="read-more-link" id="mystery-read-more">
    Read the full mystery →
  </a>
</div>

<script define:vars={{ mysteryData }}>
  const mysteryMapping = {
    1: 'The Joyful Mysteries',    // Monday
    2: 'The Sorrowful Mysteries', // Tuesday
    3: 'The Glorious Mysteries',  // Wednesday
    4: 'The Luminous Mysteries (Mysteries of Light)',  // Thursday
    5: 'The Sorrowful Mysteries', // Friday
    6: 'The Joyful Mysteries',    // Saturday
    0: 'The Glorious Mysteries'   // Sunday
  };

  function updateMystery() {
    const today = new Date();
    const dayOfWeek = today.getDay();
    const mysteryName = mysteryMapping[dayOfWeek];
    
    // Find the data object
    const mystery = mysteryData.find(m => m.title === mysteryName);
    
    if (!mystery) return; // Should not happen if data is complete

    // Update DOM
    const link = document.getElementById('mystery-link');
    const dateSpan = document.getElementById('mystery-date');
    const list = document.getElementById('mystery-ol');
    const readMore = document.getElementById('mystery-read-more');

    // Format date
    const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    
    if (link) {
        link.textContent = mystery.title;
        link.href = `/mysteries/${mystery.slug}`;
    }
    
    if (dateSpan) {
        dateSpan.textContent = today.toLocaleDateString('en-US', dateOptions);
    }
    
    if (list) {
        list.innerHTML = '';
        mystery.list.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            list.appendChild(li);
        });
    }

    if (readMore) {
        readMore.href = `/mysteries/${mystery.slug}`;
        readMore.textContent = `Read the full ${mystery.title} →`;
    }
  }

  // Run immediately
  updateMystery();

  // Check for day changes every minute
  setInterval(updateMystery, 60 * 1000);
</script>
